# 上帝模式说明
## 背景
在一些特殊情况下（如配置错误、节点机器故障、网络故障、软件故障等），区块链网络在分布式记账过程中无法满足共识算法的要求，则会导致记账节点间无法对新区块达成共识，区块链网络就会出现停止运行无法正常出块的现象。

FISCO-BCOS为了满足共识节点动态增减的要求，将记账节点列表存储于链上系统合约，任何记账节点的增减都需要通过广播区块链交易的方式来进行。在网络已无法出块的情况，任何想通过交易来变更记账节点列表的方式都无效，导致网络无法正常恢复。

因此，区块链网络需要拥有在极端情况下的网络恢复能力。
基于此考虑，FISCO-BCOS设计了上帝模式。

## 技术原理
网络停止运行的本质在于记账节点间无法达成一致。此种情况下，我们需要将故障的记账节点从参与共识记账的节点列表中剔除，并能使得全网节点都能对记账节点列表的变更保持一致。上帝模式的解决方法主要是通过指定特殊配置文件的方式来指定网络在某个区块区间内的记账节点列表。

在节点使用上帝模式期间，节点会忽略链上系统合约的记账节点列表而只认可配置文件中的记账节点，节点对共识算法出块顺序、区块签名、区块投票信息的验证都以配置文件中的为准。网络正常运行出块之后，在该配置文件指定的区间内，可以发出系统合约的节点变更交易，将故障节点从系统合约的记账节点列表中剔除，等待上帝模式运行结束之后，使用正常模式重启所有节点，即可让节点恢复到只认可链上系统合约。

假设如下场景：

网络中总共有A、B、C、D四个节点且都为记账节点。此时四个节点的区块高度都为100。此时某些特殊情况，C、D节点机器故障，暂时无法使用。由于PBFT算法要求每个区块必须有2/3的记账节点的签名投票才合法，但此时C、D无法参与共识，A与B无法收集足够的签名。因此，此时网络无法正常出块。

使用上帝模式主要有以下步骤：

1. 选择正常节点A作为上帝模式期间的记账节点，选择上帝模式的区块区间为101-200，以此准备好配置文件。
2. 使用该配置文件重启A、B节点，网络恢复正常，此时网络中只有A、B节点。
3. 发出交易调用系统记账节点列表合约，从合约中移除C、D两个节点。
4. 网络继续正常运行直至块高达到200。（如果开启了不出空块策略，则需要持续发送交易使其块高继续增长）

C、D节点恢复正常之后
1. 使用与A节点同样的上帝模式配置文件，重启C、D节点，此时网络中有A、B、C、D节点。
2. 等待C、D节点与A、B节点同步区块直到块高达到和A、B一致（达到200）。
3. 以正常模式重启A、B、C、D节点（从201开始继续增长）。
4. 至此，网络已完全恢复正常。

*注意：如果有新节点加入网络，则新节点在同步到101-200区块期间，需要使用同样的上帝模式配置文件重启来正确同步，待该期间同步完成之后，再用正常模式重启即可*

## 使用说明

### 示例上帝模式配置文件
```
{
    "godMinerStart": "0x65",//16进制 起始开始值必须是当前BlockChain的块高+1 本示例是101
   "godMinerEnd":"0xc8", // 16进制 结束上帝模式的块高  本示例是200
    "miners":[
     {
        "Nodeid": "23cf67......", // <A节点公钥 和 config.json 中一致>
        "Nodedesc": "nodeA", // <A节点描述信息 和 config.json 中填写一致>
        "Agencyinfo": "nodeA", //<A节点info信息 和 config.json 中填写一致>
        "Peerip": "127.0.0.1", // <填写A节点IP>
        "Identitytype": 1,
        "Port":31304, // <填写A节点端口>
        "Idx":0
    }
    ]
    }
```
**注意**
1. godMinerStart和godMinerEnd都是16进制
2. miners的配置请与config.json中保持一致
3. godMinerEnd必须大于等于godMinerStart
4. godMinerStart必须等于当前blockchain的块高+1

### 上帝模式启动命令
```
fisco-bcos --genesis ./genesis.json --config ./config.json --godminer ./godminer.json #正常模式启动命令没有--godminer ./godminer.json
```


如果您觉得本文不错，欢迎[戳这里](https://github.com/FISCO-BCOS/FISCO-BCOS)给FISCO BCOS打star:star:。


